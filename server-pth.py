import socket  # –†–∞–±–æ—Ç–∞ —Å —Å–µ—Ç–µ–≤—ã–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏

# –í–≤–æ–¥ –ø–æ—Ä—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
port = int(input("–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: "))

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TCP-—Å–æ–∫–µ—Ç–∞ –Ω–∞ IPv4
server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

# –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

# –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–∫–µ—Ç–∞ –∫–æ –≤—Å–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º –º–∞—à–∏–Ω—ã –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ—Ä—Ç—É
server_socket.bind(("0.0.0.0", port))

print("‚ñ∂ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")

# –°–ª—É—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ß–∏—Å–ª–æ –≤ —Å–∫–æ–±–∫–∞—Ö ‚Äî –º–∞–∫—Å. —á–∏—Å–ª–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
server_socket.listen(1)
print(f"‚ñ∂ –ü–æ—Ä—Ç {port} –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.")

# –¶–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
while True:
    try:
        # –û–∂–∏–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
        client_socket, client_addr = server_socket.accept()
        print("üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç.")
        print(f"üìç IP: {client_addr[0]}  |  –ü–æ—Ä—Ç: {client_addr[1]}")

        buffer = ""  # –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

        # –ü—Ä–∏—ë–º –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        while True:
            data = client_socket.recv(1024)
            if not data:
                print("üîÑ –ö–ª–∏–µ–Ω—Ç –∑–∞–∫—Ä—ã–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.")
                break

            buffer += data.decode("utf-8")

            while "\n" in buffer:
                line, buffer = buffer.split("\n", 1)
                print(f"üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {line}")

                if line.lower() == "exit":
                    print("‚ùå –ö–æ–º–∞–Ω–¥–∞ 'exit'. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—â–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º.")
                    client_socket.send("–°–µ—Ä–≤–µ—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.\n".encode("utf-8"))
                    break

                reply = line.upper()
                client_socket.send((reply + "\n").encode("utf-8"))
                print("üì§ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É.")

            if line.lower() == "exit":
                break

        client_socket.close()
        print("üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...")

    except KeyboardInterrupt:
        print("\n‚õî –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞.")
        break

# –§–∏–Ω–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–∫–µ—Ç–∞
server_socket.close()
print("üõë –°–µ—Ä–≤–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω.")
